<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Weather App — Current + 5-day Forecast</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
  <style>
      body{
        font-family: "Montserrat", sans-serif;
        font-optical-sizing: auto;
        font-weight: 600;
        font-style: normal;
        background:url("https://static.vecteezy.com/system/resources/thumbnails/042/195/725/small_2x/ai-generated-rainy-sky-background-free-photo.jpg");
        padding:18px;
        background-repeat: no-repeat;
        background-size: cover;
      }
      .container{
        max-width:75%;
        margin:28px auto;
      }
      .card{
        padding: 4%;
        border-radius:12px;
        background: rgba(255,255,255,0.6);
        box-shadow:0 6px 24px rgba(11,22,39,0.06);
      }
      .controls{
        display:flex;
        gap:8px;
        align-items:center;
        flex-wrap:wrap;
      }
      form input[type="text"]{
        padding:8px 12px;
        border-radius:8px;
        border:1px solid #ddd;
        width:280px;
      }
      form select{
        padding:8px;
        border-radius:8px;
        border:1px solid #ddd;
      }
      button{
        padding:8px 12px;
        border-radius:8px;
        border:none;
        background:#2563eb;
        color:#fff;
        cursor:pointer;
      }
      button.secondary{
        background:#6b7280;
      }
      .weather{
        margin-top:16px;
      }
      .meta{
        color:#555;
        font-size:14px;
      }
      .forecast-grid{
        display:flex;
        gap:8px;
        margin-top:14px;
        flex-wrap:wrap;
      }
      .day{
        flex:1 1 120px;
        background:#f8fafc;
        border-radius:8px;
        padding:10px;
        text-align:center;
      }
      .day h4{
        margin:8px 0 4px;
      }
      canvas{
        max-width:100%;
        height:240px;
      }
      .error{
        color:#b00020;
        margin-top:12px;
      }
      .small{
        font-size:13px;
        color:#666;
      }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Weather Lookup</h1>

      <form id="search-form" method="get" action="">
        <div class="controls">
          {{ form.city }}
          {{ form.units }}
          <button type="submit">Get Weather</button>
          <button id="use-location" type="button" class="secondary">Use My Location</button>
          <button id="clear" type="button" class="secondary">Clear</button>
        </div>
        <!-- Hidden lat/lon fields (if present in the form, Django will render hidden inputs) -->
        {{ form.lat }}{{ form.lon }}
      </form>

      {% if error %}
        <p class="error">{{ error }}</p>
      {% endif %}

      {% if weather %}
        <div class="weather">
          <h3>{{ weather.city }}</h3>
          <p>
            <img class="icon" src="https://openweathermap.org/img/wn/{{ weather.icon }}@2x.png" alt="icon" style="vertical-align:middle">
            <strong style="font-size:1.6rem">{{ weather.temp }}{{ weather.units }}</strong>
            — {{ weather.description }}
          </p>
          <p class="meta">
            Feels like: {{ weather.feels_like }}{{ weather.units }} |
            Humidity: {{ weather.humidity }}% |
            Wind: {{ weather.wind_speed }} m/s
            <span class="small"> | Sunrise: {{ weather.sunrise }} — Sunset: {{ weather.sunset }}</span>
          </p>
        </div>

        {% if forecast %}
          <hr style="margin-top:18px">
          <h4>5-day forecast</h4>
          <div class="forecast-grid" id="forecast-list">
            {% for d in forecast.daily %}
              <div class="day">
                <div class="small">{{ d.date }}</div>
                <img src="https://openweathermap.org/img/wn/{{ d.icon }}@2x.png" alt="icon" style="width:64px;height:64px">
                <h4>{{ d.temp_max|floatformat:1 }} / {{ d.temp_min|floatformat:1 }} {{ forecast.units }}</h4>
                <div class="small">{{ d.desc }}</div>
              </div>
            {% endfor %}
          </div>

          <div style="margin-top:12px" class="card" id="chart-card">
            <h4>Average temperature (next days)</h4>
            <canvas id="forecastChart"></canvas>
          </div>
        {% endif %}
      {% else %}
        <p class="meta">Enter a city (e.g. "Paris" or "Paris,FR") and press Get Weather, or click "Use My Location".</p>
      {% endif %}
    </div>
  </div>

<script>
  // Elements
  const useLocationBtn = document.getElementById('use-location');
  const clearBtn = document.getElementById('clear');
  const form = document.getElementById('search-form');
  const cityInput = document.getElementById('id_city') || document.getElementById('city-input');
  const unitsSelect = document.getElementById('id_units') || document.getElementById('units-select');

  // When Use My Location clicked: get coords and redirect to same page with lat/lon & units
  useLocationBtn?.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }
    useLocationBtn.disabled = true;
    useLocationBtn.textContent = 'Locating…';
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const units = unitsSelect ? unitsSelect.value : 'metric';
        // Redirect with lat/lon and units; server will pick them up
        const params = new URLSearchParams({ lat: lat, lon: lon, units: units });
        window.location.search = params.toString();
      },
      (err) => {
        useLocationBtn.disabled = false;
        useLocationBtn.textContent = 'Use My Location';
        alert('Unable to retrieve your location: ' + err.message);
      },
      { timeout: 10000, maximumAge: 60000 }
    );
  });

  // Clear form
  clearBtn?.addEventListener('click', () => {
    if (cityInput) cityInput.value = '';
    if (unitsSelect) unitsSelect.value = 'metric';
    // Remove query params
    history.replaceState(null, '', window.location.pathname);
  });

  // Chart rendering if forecast chart data present via server-rendered JS object
  {% if forecast %}
    (function renderChart() {
      const labels = {{ forecast.chart.labels|safe }};
      const data = {{ forecast.chart.data|safe }};

      const ctx = document.getElementById('forecastChart').getContext('2d');
      // Destroy existing chart if re-rendered
      if (window._forecastChart) {
        window._forecastChart.destroy();
      }
      window._forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Avg Temp ({{ forecast.units }})',
            data: data,
            tension: 0.3,
            fill: false,
            borderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { display: true },
            y: { display: true }
          }
        }
      });
    })();
  {% endif %}
</script>

</body>
</html>
